# SPDX-FileCopyrightText: None
# SPDX-License-Identifier: CC0-1.0

include:
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/linux-qt6.yml
      - /gitlab-templates/alpine-qt6.yml # For the apk backend

# Commented out because they don't support appstreamqt yet, and it's probably fine
#     - /gitlab-templates/freebsd-qt6.yml
      - /gitlab-templates/xml-lint.yml
      - /gitlab-templates/yaml-lint.yml
      - /gitlab-templates/qml-lint.yml
      - /gitlab-templates/linux-qt6-next.yml

# Test job to check if mkosi and systemd-nspawn work in CI
test_systemd_tooling:
  extends:
    - .ci_linux_base
    - .suse_tumbleweed_qt6stable
  stage: build
  rules:
    # Only run manually for now to avoid affecting main pipeline
    - when: manual
      allow_failure: true
  script:
    - echo "=== Testing systemd-nspawn and mkosi availability ==="
    
    # Check systemd version
    - echo "Checking systemd version..."
    - systemctl --version || echo "systemd not available"
    
    # Check if systemd-nspawn is available
    - echo "Checking systemd-nspawn..."
    - which systemd-nspawn || echo "systemd-nspawn not found"
    - systemd-nspawn --version || echo "systemd-nspawn execution failed"
    
    # Check if mkosi is available
    - echo "Checking mkosi..."
    - which mkosi || echo "mkosi not found"
    
    # Try to install mkosi if not available
    - |
      if ! which mkosi; then
        echo "Attempting to install mkosi..."
        zypper --non-interactive install mkosi || pip3 install mkosi || echo "Failed to install mkosi"
      fi
    
    # Check mkosi version if available
    - mkosi --version || echo "mkosi not available after installation attempt"
    
    # Check kernel capabilities needed for containers
    - echo "Checking kernel capabilities..."
    - cat /proc/sys/kernel/unprivileged_userns_clone || echo "unprivileged_userns_clone not available"
    - ls -la /sys/fs/cgroup/ || echo "cgroup fs not accessible"
    
    # Check if we can create namespaces
    - echo "Testing namespace creation..."
    - unshare --user --pid --fork echo "User and PID namespace test successful" || echo "Namespace creation failed"
    
    # Try a simple systemd-nspawn test if available
    - |
      if which systemd-nspawn; then
        echo "Testing systemd-nspawn with a simple container..."
        # Create a minimal directory structure
        mkdir -p /tmp/test-container/usr/bin
        # Try to run a minimal nspawn (this might fail due to permissions)
        systemd-nspawn -D /tmp/test-container --pipe echo "nspawn test" || echo "systemd-nspawn test failed (might need privileged mode)"
      fi
    
    # Check if we're running in a container ourselves
    - echo "Checking if we're in a container..."
    - systemd-detect-virt || echo "systemd-detect-virt not available"
    
    # Check available capabilities
    - echo "Checking capabilities..."
    - capsh --print || getpcaps $$ || echo "Cannot check capabilities"
    
    # Summary
    - echo "=== Summary ==="
    - echo "If mkosi and systemd-nspawn are available and working, we can proceed with building systemd from git."
    - echo "Otherwise, we'll need to create a custom Docker/VM image with these tools pre-configured."
  artifacts:
    when: always
    paths:
      - "*.log"
    expire_in: 1 week

# Full systemd-sysupdate backend test with latest systemd
# This job will build systemd from git master and test the backend
test_systemd_sysupdate_backend:
  extends:
    - .ci_linux_base
    - .suse_tumbleweed_qt6stable
  stage: build
  rules:
    # Only run manually for now
    - when: manual
      allow_failure: true
  variables:
    SYSTEMD_GIT_URL: "https://github.com/systemd/systemd.git"
    SYSTEMD_BUILD_DIR: "/tmp/systemd-build"
  before_script:
    - !reference [.ci_linux_base, before_script]
    # Install dependencies for building systemd from source
    - echo "Installing systemd build dependencies..."
    - zypper --non-interactive install -y meson ninja git gcc g++ python3 python3-jinja2 gperf
    - zypper --non-interactive install -y libcap-devel libmount-devel libkmod-devel libblkid-devel
    - zypper --non-interactive install -y libacl-devel libcryptsetup-devel libgcrypt-devel liblz4-devel
    - zypper --non-interactive install -y libzstd-devel libxkbcommon-devel libcurl-devel libgnutls-devel
    - zypper --non-interactive install -y python3-pyelftools || true
    # Try to install mkosi
    - zypper --non-interactive install -y mkosi || pip3 install mkosi || echo "mkosi installation failed"
  script:
    - echo "=== Building systemd from git master ==="
    
    # Clone systemd
    - git clone --depth=1 ${SYSTEMD_GIT_URL} ${SYSTEMD_BUILD_DIR}
    - cd ${SYSTEMD_BUILD_DIR}
    
    # Configure and build systemd
    - |
      meson setup build \
        --prefix=/usr/local \
        --buildtype=debug \
        -Dsysupdate=true \
        -Dukify=false \
        -Dbootloader=false \
        -Defi=false \
        || echo "Meson setup failed"
    
    - ninja -C build systemd-sysupdated systemd-sysupdate || echo "Build failed"
    
    # Install systemd binaries to a temporary location
    - DESTDIR=/tmp/systemd-install ninja -C build install || echo "Install failed"
    
    # Go back to discover source
    - cd ${CI_PROJECT_DIR}
    
    # Clone ci-utilities if not already done
    - git clone https://invent.kde.org/sysadmin/ci-utilities.git --depth=1 || true
    - git clone https://invent.kde.org/sysadmin/repo-metadata.git ci-utilities/repo-metadata/ --depth=1 || true
    
    # Set up environment to use the newly built systemd
    - export PATH="/tmp/systemd-install/usr/local/bin:$PATH"
    - export LD_LIBRARY_PATH="/tmp/systemd-install/usr/local/lib:$LD_LIBRARY_PATH"
    
    # Start the mock systemd-sysupdate D-Bus service for testing
    - echo "Starting mock systemd-sysupdate service..."
    - python3 libdiscover/backends/SystemdSysupdateBackend/test/mockserver.py &
    - MOCK_SERVER_PID=$!
    - sleep 2  # Give the mock server time to start
    
    # Build discover with systemd-sysupdate backend enabled
    - echo "Building Discover with SystemdSysupdateBackend..."
    - python3 -u ci-utilities/run-ci-build.py \
        --project ${CI_PROJECT_NAME} \
        --branch ${CI_COMMIT_REF_NAME} \
        --platform Linux/Qt6/Shared \
        --extra-cmake-args=-DBUILD_WITH_QT6=ON \
        --extra-cmake-args=-DQT_MAJOR_VERSION=6 \
        --extra-cmake-args=-DBUILD_SystemdSysupdateBackend=ON
    
    # Run tests
    - echo "Running tests..."
    - cd build
    - ctest --output-on-failure -R systemd || echo "Tests failed or not found"
    
    # Clean up mock server
    - kill ${MOCK_SERVER_PID} || true
    
  after_script:
    - ci-utilities/run-collect-crashes.py || true
  artifacts:
    when: always
    paths:
      - "build/Testing/"
      - "*.log"
      - "systemd-build.log"
    reports:
      junit: JUnitTestResults.xml
    expire_in: 1 week
